<!DOCTYPE html>
<html>
<head>
  <title>Privacy Guard Connection Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 50px auto;
      padding: 20px;
    }
    button {
      padding: 10px 20px;
      margin: 10px;
      font-size: 16px;
      cursor: pointer;
    }
    #results {
      margin-top: 20px;
      padding: 10px;
      background: #f5f5f5;
      border-radius: 5px;
    }
    .success { color: green; }
    .error { color: red; }
  </style>
</head>
<body>
  <h1>Privacy Guard Connection Test</h1>
  <p>Use this page to test if the service worker is responding.</p>
  
  <button onclick="testConnection()">Test Connection</button>
  <button onclick="testAnalyze()">Test Analyze Message</button>
  <button onclick="checkServiceWorker()">Check Service Worker Status</button>
  
  <div id="results"></div>

  <script>
    function log(message, type = 'info') {
      const results = document.getElementById('results');
      const div = document.createElement('div');
      div.className = type;
      div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      results.appendChild(div);
      console.log(message);
    }

    async function testConnection() {
      log('Testing connection...', 'info');
      try {
        const response = await chrome.runtime.sendMessage({ type: 'TEST' });
        if (response) {
          log('✅ Connection successful! Response: ' + JSON.stringify(response), 'success');
        } else {
          log('⚠️ No response received', 'error');
        }
      } catch (error) {
        log('❌ Connection failed: ' + error.message, 'error');
        log('Error details: ' + JSON.stringify(error), 'error');
      }
    }

    async function testAnalyze() {
      log('Testing ANALYZE_DOCUMENT message...', 'info');
      try {
        const response = await chrome.runtime.sendMessage({
          type: 'ANALYZE_DOCUMENT',
          payload: {
            url: 'https://example.com/terms',
            text: 'This is a test document with enough text to analyze. It contains terms and conditions that users should review carefully before agreeing.',
            mode: 'local',
            provider: 'auto',
          },
        });
        if (response?.success) {
          log('✅ Analysis successful!', 'success');
          log('Result: ' + JSON.stringify(response).substring(0, 200) + '...', 'info');
        } else {
          log('❌ Analysis failed: ' + (response?.error || 'Unknown error'), 'error');
        }
      } catch (error) {
        log('❌ Analysis error: ' + error.message, 'error');
      }
    }

    async function checkServiceWorker() {
      log('Checking service worker status...', 'info');
      try {
        // Try to get extension info
        const extensionId = chrome.runtime.id;
        log('Extension ID: ' + extensionId, 'info');
        
        // Check if we can access runtime
        if (chrome.runtime.lastError) {
          log('❌ Runtime error: ' + chrome.runtime.lastError.message, 'error');
        } else {
          log('✅ Runtime accessible', 'success');
        }
      } catch (error) {
        log('❌ Error checking service worker: ' + error.message, 'error');
      }
    }

    // Auto-test on load
    window.addEventListener('load', () => {
      setTimeout(testConnection, 1000);
    });
  </script>
</body>
</html>

